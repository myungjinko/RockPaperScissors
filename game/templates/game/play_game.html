{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rock Paper Scissors</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
        .main-container { display: flex; max-width: 1200px; margin: 0 auto; gap: 30px; }
        .game-section { flex: 2; }
        .leaderboard-section { flex: 1; }
        .game-container { background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .leaderboard-container { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); height: fit-content; }
        .choice-container { display: flex; justify-content: center; gap: 20px; margin: 20px 0 50px 0; }
        .choice-button { background: none; border: none; cursor: pointer; padding: 10px; border-radius: 10px; transition: transform 0.2s; }
        .choice-button:hover { transform: scale(1.1); }
        .choice-button img { width: 150px; height: 150px; object-fit: contain; }
        .choice-label { display: block; margin-top: 15px; font-weight: bold; color: #333; font-size: 18px; }
        .result { margin-top: 50px; font-size: 28px; font-weight: bold; }
        .result-win { color: #28a745; }
        .result-lose { color: #dc3545; }
        .result-draw { color: #6c757d; }
        .choices-display { display: flex; justify-content: center; gap: 40px; margin: 20px 0; }
        .choice-display { text-align: center; }
        .choice-display img { width: 120px; height: 120px; object-fit: contain; }
        .choice-display .label { font-size: 16px; font-weight: bold; margin-top: 10px; }
        .shuffling { animation: shuffle 0.3s ease-in-out; }
        @keyframes shuffle {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .hidden { display: none; }
        .player-name-input { margin-bottom: 20px; }
        .player-name-input input { padding: 10px; font-size: 16px; border: 1px solid #ddd; border-radius: 5px; width: 200px; }
        .leaderboard-title { font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #333; }
        .leaderboard-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .leaderboard-item:last-child { border-bottom: none; }
        .player-rank { font-weight: bold; color: #007bff; }
        .player-stats { font-size: 14px; color: #666; }
        .winner-border { border: 6px solid #28a745; border-radius: 15px; padding: 10px; }
    </style>
    <script>
        // Store static URL for images
        const staticUrl = "{% static 'game/' %}";
        // Always use the player name from the template context
        const playerNameFromSession = "{{ player_name|escapejs }}";
        
        function playGame(choice) {
            // Always use the player name from the session/template context
            const playerName = playerNameFromSession || 'Anonymous';
            // Hide the game buttons
            const choiceContainer = document.querySelector('.choice-container');
            if (choiceContainer) {
                choiceContainer.style.display = 'none';
            }
            // Show shuffling animation
            const resultDiv = document.getElementById('result-container');
            if (resultDiv) {
                resultDiv.style.display = 'block';
                // Create shuffling animation
                const choices = ['rock', 'paper', 'scissors'];
                let currentIndex = 0;
                let shuffleCount = 0;
                const maxShuffles = 10; // Number of shuffles before revealing
                const shuffleInterval = setInterval(() => {
                    const currentChoice = choices[currentIndex];
                    resultDiv.innerHTML = 
                        '<div style="text-align: center; margin: 40px 0;">' +
                        '<div style="font-size: 24px; margin-bottom: 20px;">Computer is choosing...</div>' +
                        '<img src="' + staticUrl + currentChoice + '.png" alt="' + currentChoice + '" style="width: 150px; height: 150px; object-fit: contain;">' +
                        '<div style="font-size: 18px; margin-top: 15px; font-weight: bold;">' + currentChoice.charAt(0).toUpperCase() + currentChoice.slice(1) + '</div>' +
                        '</div>';
                    currentIndex = (currentIndex + 1) % choices.length;
                    shuffleCount++;
                    if (shuffleCount >= maxShuffles) {
                        clearInterval(shuffleInterval);
                        // Submit the form after animation
                        setTimeout(() => {
                            const form = document.createElement('form');
                            form.method = 'POST';
                            // Add CSRF token from hidden input
                            const csrfToken = document.getElementById('js-csrf-token').value;
                            form.innerHTML =
                                '<input type="hidden" name="csrfmiddlewaretoken" value="' + csrfToken + '">' +
                                '<input type="hidden" name="choice" value="' + choice + '">' +
                                '<input type="hidden" name="player_name" value="' + playerName + '">';
                            document.body.appendChild(form);
                            form.submit();
                        }, 500); // Wait 0.5 seconds after last shuffle
                    }
                }, 200); // Change every 200ms
            }
        }

        // Show result container if there's a result
        document.addEventListener('DOMContentLoaded', function() {
            {% if result %}
                const resultContainer = document.getElementById('result-container');
                if (resultContainer) {
                    resultContainer.style.display = 'block';
                }
            {% endif %}
        });
    </script>
</head>
<body>
    <div class="main-container">
        <div class="game-section">
            <div class="game-container">
                <h1>Rock Paper Scissors</h1>
                
                <form method="post" style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    {% csrf_token %}
                    <input type="text" id="player-name" name="player_name" placeholder="Enter your name" value="{{ player_name|default:'' }}" style="padding: 10px; font-size: 16px; border: 1px solid #ddd; border-radius: 5px; width: 200px;">
                    <button type="submit" name="set_player_name" style="font-size: 16px; padding: 10px 18px; border-radius: 6px; border: none; background: #007bff; color: #fff; cursor: pointer;">Set Name</button>
                </form>
                <form method="post">
                    {% csrf_token %}
                    <div class="choice-container">
                        {% for choice in choices %}
                            <button type="button" onclick="playGame('{{ choice }}')" class="choice-button">
                                <img src="{% static 'game/'|add:choice|add:'.png' %}" alt="{{ choice|title }}">
                                <span class="choice-label">{{ choice|title }}</span>
                            </button>
                        {% endfor %}
                    </div>
                </form>
                <div id="result-container" class="hidden">
                    <!-- Animation and results will be shown here -->
                    {% if result %}
                        <div class="choices-display">
                            <div class="choice-display">
                                <img src="{% static 'game/'|add:user_choice|add:'.png' %}" alt="{{ user_choice|title }}" {% if result == 'You win!' %}class="winner-border"{% endif %}>
                                <div class="label">You chose {{ user_choice|title }}</div>
                            </div>
                            <div class="choice-display">
                                <img src="{% static 'game/'|add:computer_choice|add:'.png' %}" alt="{{ computer_choice|title }}" {% if result == 'You lose!' %}class="winner-border"{% endif %}>
                                <div class="label">Computer chose {{ computer_choice|title }}</div>
                            </div>
                        </div>
                        <div class="result {% if result == 'You win!' %}result-win{% elif result == 'You lose!' %}result-lose{% else %}result-draw{% endif %}">
                            {{ result }}
                        </div>
                    {% endif %}
                </div>
                <div style="margin-top: 40px; font-size: 22px; font-weight: bold;">
                    Score: {{ player_name|default:'You' }} {{ player_score }} : {{ computer_score }} Computer
                </div>
                <form method="post" style="margin-top: 20px;">
                    {% csrf_token %}
                    <button type="submit" name="reset_score" style="font-size: 16px; padding: 10px 20px; border-radius: 6px; border: none; background: #dc3545; color: #fff; cursor: pointer;">Reset Score</button>
                </form>
                <input type="hidden" id="js-csrf-token" value="{{ csrf_token }}">
            </div>
        </div>
        
        <div class="leaderboard-section">
            <div class="leaderboard-container">
                <div class="leaderboard-title">üèÜ Leaderboard</div>
                {% if leaderboard %}
                    {% for player in leaderboard %}
                        <div class="leaderboard-item">
                            <div>
                                <span class="player-rank">#{{ forloop.counter }}</span>
                                <span style="margin-left: 10px;">{{ player.name }}</span>
                            </div>
                            <div class="player-stats">
                                {{ player.win_percentage }}% ({{ player.wins }}-{{ player.losses }}-{{ player.draws }})
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div style="text-align: center; color: #666; font-style: italic;">
                        No players yet. Start playing to see the leaderboard!
                    </div>
                {% endif %}
            </div>
            <form method="post" style="margin-top: 20px; text-align: center;">
                {% csrf_token %}
                <button type="submit" name="reset_leaderboard" style="font-size: 16px; padding: 10px 20px; border-radius: 6px; border: none; background: #dc3545; color: #fff; cursor: pointer;">Reset Leaderboard</button>
            </form>
        </div>
    </div>
</body>
</html> 